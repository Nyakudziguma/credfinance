{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="left-part bg-white fixed-left-part">
    <a class="ti-menu ti-close btn btn-success show-left-part d-block d-md-none" href="javascript:void(0)"></a>
    <div class="p-15">
        <h4>Chat Sidebar</h4>
    </div>
    <div class="scrollable position-relative" style="height:100%;">
        <div class="p-15">
            <h5 class="card-title">Search Contact</h5>
            <form>
                <input class="form-control" type="text" placeholder="Search Contact">
            </form>
        </div>
        <hr>
        <ul class="mailbox list-style-none">
            <li>
                <div class="message-center chat-scroll">
                    {% for chatroom in chatrooms %}
                    <a href="{% url 'chatroom' chatroom.id %}" class="message-item" data-chatroom-id="{{ chatroom.id }}">
                        <span class="user-img">
                            <img src="{% static 'assets/images/users/user (1).png' %}" alt="agent" class="rounded-circle">
                            <span class="profile-status online pull-right"></span>
                        </span>
                        <div class="mail-contnet">
                            <h5 class="message-title">{{ chatroom.client.name }}</h5> 
                            {% include 'apps/chatroom_list.html' %}
                        </div>
                    </a>
                    {% endfor %}
                </div>
            </li>
        </ul>
    </div>
</div>

<!-- Right Part Mail Compose -->
<div class="right-part">
    <div class="p-20">
        <div class="card">
            <div class="card-body">
                <h4 class="card-title">Chat Messages</h4>
                <div id="chat-box" class="chat-box scrollable" style="height:calc(100vh - 300px);" hx-trigger="htmx:afterRequest">
                    {% if chatroom %}
                    <ul class="chat-list" id="message-list">
                        {% for message in messages %}
                          {% include 'apps/chat_message.html' %}
                        {% endfor %}
                    </ul>
                    {% else %}
                        <p>Select a chatroom to view messages</p>
                    {% endif %}
                </div>
            </div>

            <div class="card-body border-top">
                <div class="row">
                    <div class="col-9">
                        <form 
                            id="messageForm"
                            hx-post="{% if chatroom %}{% url 'send_message' chatroom.id %}{% else %}#{% endif %}"

                            hx-target="#message-list"
                            hx-swap="beforeend"
                        >
                            {% csrf_token %}
                            <div class="input-field m-t-0 m-b-0">
                                <input 
                                    id="messageInput" 
                                    name="content" 
                                    placeholder="Type and enter" 
                                    class="form-control border-0" 
                                    type="text" 
                                    required
                                >
                            </div>
                        </form>
                    </div>
                    <div class="col-3">
                        <button 
                            type="button" 
                            class="btn-circle btn-lg btn-cyan float-right text-white"
                            onclick="submitMessage()"
                        >
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;

        // Scroll functions
        function scrollToBottom() {
            const chatBox = document.getElementById('chat-box');
            if (chatBox) {
                chatBox.scrollTop = chatBox.scrollHeight;
            }
        }

        // HTMX after request handler
        document.body.addEventListener('htmx:afterRequest', function(event) {
            scrollToBottom();
            
            const input = document.getElementById('messageInput');
            if (input) {
                input.value = '';
            }
        });

        // Submit message function
        function submitMessage() {
            const form = document.getElementById('messageForm');
            const input = document.getElementById('messageInput');
            
            if (input && input.value.trim()) {
                htmx.trigger(form, 'submit');
            }
        }

        // Enter key handler
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                submitMessage();
            }
        });

        // Make submitMessage available globally
        window.submitMessage = submitMessage;

        // WebSocket connection
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const chatSocket = new WebSocket(
                `${protocol}//${window.location.host}/wss/chat/{{ chatroom.id }}/`
            );

            chatSocket.onmessage = function(e) {
                const data = JSON.parse(e.data);
                console.log('Received data from WebSocket:', data);
                
                // Only append message if it contains HTML and isn't already in the list
                const messageList = document.getElementById('message-list');
                if (messageList && data.html) {
                    const messageId = data.message.id;
                    if (!document.querySelector(`[data-message-id="${messageId}"]`)) {
                        messageList.insertAdjacentHTML('beforeend', data.html);
                        scrollToBottom();
                    }
                }
            };

            chatSocket.onerror = function(error) {
                console.error('WebSocket error:', error);
            };

            chatSocket.onclose = function(e) {
                console.log('Chat socket closed:', e);
                
                if (reconnectAttempts < maxReconnectAttempts) {
                    console.log(`Attempting to reconnect... (${reconnectAttempts + 1}/${maxReconnectAttempts})`);
                    reconnectAttempts++;
                    setTimeout(connectWebSocket, 3000);
                } else {
                    console.log('Max reconnection attempts reached');
                }
            };

            chatSocket.onopen = function() {
                console.log('WebSocket connected');
                reconnectAttempts = 0;
            };

            return chatSocket;
        }

        // Initial connection
        let chatSocket = connectWebSocket();
        
        // Initial scroll to bottom
        scrollToBottom();
    });
</script>

{% endblock %}
{% endblock %}