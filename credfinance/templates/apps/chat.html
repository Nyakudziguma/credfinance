{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="left-part bg-white fixed-left-part">
    <a class="ti-menu ti-close btn btn-success show-left-part d-block d-md-none" href="javascript:void(0)"></a>
    <div class="p-15">
        <h4>Chat Sidebar</h4>
    </div>
    <div class="scrollable position-relative" style="height:100%;">
        <div class="p-15">
            <h5 class="card-title">Search Contact</h5>
            <form>
                <input class="form-control" type="text" placeholder="Search Contact">
            </form>
        </div>
        <hr>
        <ul class="mailbox list-style-none">
            <li>
                <div class="message-center chat-scroll">
                    {% for chatroom in chatrooms %}
                    <a href="{% url 'chatroom' chatroom.id %}" class="message-item" data-chatroom-id="{{ chatroom.id }}">
                        <span class="user-img">
                            <img src="{% static 'assets/images/users/user (1).png' %}" alt="agent" class="rounded-circle">
                            <span class="profile-status online pull-right"></span>
                        </span>
                        <div class="mail-contnet">
                            <h5 class="message-title">{{ chatroom.client.name }}</h5> 
                            <span class="mail-desc">{{ chatroom.latest_message.content }}</span> 
                            <span class="time">{{ chatroom.latest_message.timestamp }}</span> 
                        </div>
                    </a>
                    {% endfor %}
                </div>
            </li>
        </ul>
    </div>
</div>

<!-- Right Part Mail Compose -->
<div class="right-part">
    <div class="p-20">
        <div class="card">
            <div class="card-body">
                <h4 class="card-title">Chat Messages</h4>
                <div id="chat-box" class="chat-box scrollable" style="height:calc(100vh - 300px);" hx-trigger="htmx:afterRequest">
                    {% if chatroom %}
                    <ul class="chat-list" id="message-list">
                        {% for message in messages %}
                          {% include 'apps/chat_message.html' %}
                        {% endfor %}
                    </ul>
                    {% else %}
                        <p>Select a chatroom to view messages</p>
                    {% endif %}
                </div>
            </div>

            <div class="card-body border-top">
                <div class="row">
                    <div class="col-9">
                        <!-- Form for sending a new message using HTMX -->
                        <form 
                            hx-ext="ws" 
                            ws-connect="/wss/chat/{{ chatroom.id }}/" 
                            ws-send="{'content': value}" 
                            onsubmit="return false;" 
                        >
                            {% csrf_token %}
                            <div class="input-field m-t-0 m-b-0">
                                <input id="replyTextarea" name="content" placeholder="Type and enter" class="form-control border-0" type="text" required>
                            </div>
                        </form>

                    </div>
                    <div class="col-3">
                        <button class="btn-circle btn-lg btn-cyan float-right text-white" type="submit">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script>
  // Function to scroll chat-box to the bottom
  function scrollToBottom() {
    const chatBox = document.getElementById('chat-box');
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  // Call scrollToBottom when HTMX request is complete (new message sent or page load)
  document.body.addEventListener('htmx:afterRequest', function(event) {
    if (event.target.id === 'chat-box') {
      scrollToBottom();
    }
  });

  // Ensure chat scrolls to the bottom on page load
//   window.addEventListener('load', scrollToBottom);

//   document.body.addEventListener('htmx:ws-open', function(event) {
//     console.log('WebSocket connected:', event);
// });

// document.body.addEventListener('htmx:ws-message', function(event) {
//     console.log('WebSocket message received:', event.detail);
// });

</script>
{% endblock %}

{% endblock %}
