{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="left-part bg-white fixed-left-part">
    <a class="ti-menu ti-close btn btn-success show-left-part d-block d-md-none" href="javascript:void(0)"></a>
    <div class="p-15">
        <h4>Chat Sidebar</h4>
    </div>
    <div class="scrollable position-relative" style="height:100%;">
        <div class="p-15">
            <h5 class="card-title">Search Contact</h5>
            <form>
                <input class="form-control" type="text" placeholder="Search Contact">
            </form>
        </div>
        <hr>
        <ul class="mailbox list-style-none">
            <li>
                <div class="message-center chat-scroll">
                    {% for chatroom in chatrooms %}
                    <a href="{% url 'chatroom' chatroom.id %}" class="message-item" data-chatroom-id="{{ chatroom.id }}">
                        <span class="user-img">
                            <img src="{% static 'assets/images/users/user (1).png' %}" alt="agent" class="rounded-circle">
                            <span class="profile-status online pull-right"></span>
                        </span>
                        <div class="mail-contnet">
                            <h5 class="message-title">{{ chatroom.client.name }}</h5> 
                            {% include 'apps/chatroom_list.html' %}
                        </div>
                    </a>
                    {% endfor %}
                </div>
            </li>
        </ul>
    </div>
</div>

<!-- Right Part Mail Compose -->
<div class="right-part">
    <div class="p-20">
        <div class="card">
            <div class="card-body">
                <h4 class="card-title">Chat Messages</h4>
                <div id="chat-box" class="chat-box scrollable" style="height:calc(100vh - 300px);" hx-trigger="htmx:afterRequest">
                    {% if chatroom %}
                    <ul class="chat-list" id="message-list">
                        {% for message in messages %}
                          {% include 'apps/chat_message.html' %}
                        {% endfor %}
                    </ul>
                    {% else %}
                        <p>Select a chatroom to view messages</p>
                    {% endif %}
                </div>
            </div>

            <div class="card-body border-top">
                <div class="row">
                    <div class="col-9">
                        <form 
                            id="messageForm"
                            hx-post="{% url 'send_message' chatroom.id %}"
                            hx-target="#message-list"
                            hx-swap="beforeend"
                        >
                            {% csrf_token %}
                            <div class="input-field m-t-0 m-b-0">
                                <input 
                                    id="messageInput" 
                                    name="content" 
                                    placeholder="Type and enter" 
                                    class="form-control border-0" 
                                    type="text" 
                                    required
                                >
                            </div>
                        </form>
                    </div>
                    <div class="col-3">
                        <button 
                            type="button" 
                            class="btn-circle btn-lg btn-cyan float-right text-white"
                            onclick="submitMessage()"
                        >
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% block scripts %}

<script>
  function scrollToBottom() {
    const chatBox = document.getElementById('chat-box');
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  document.body.addEventListener('htmx:afterRequest', function(event) {
    scrollToBottom();
    const input = document.getElementById('messageInput');
    if (input) {
      input.value = '';
    }
  });

  window.addEventListener('load', scrollToBottom);

  function submitMessage() {
    const form = document.getElementById('messageForm');
    const input = document.getElementById('messageInput');
    
    if (input.value.trim()) {
      htmx.trigger(form, 'submit');
    }
  }

  // Add enter key support
  document.getElementById('messageInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      submitMessage();
    }
  });

  // WebSocket connection for chat messages
  const chatSocket = new WebSocket(
    'ws://' + window.location.host + '/wss/chat/{{ chatroom.id }}/'
  );

  chatSocket.onmessage = function(e) {
    const data = JSON.parse(e.data);
    const messageList = document.getElementById('message-list');
    if (messageList && data.html) {
      messageList.insertAdjacentHTML('beforeend', data.html);
      scrollToBottom();
    }
  };

  chatSocket.onclose = function(e) {
    console.error('Chat socket closed unexpectedly');
  };

  // WebSocket connection for chatroom list updates
  const chatroomListSocket = new WebSocket(
    'ws://' + window.location.host + '/wss/chatroom_list/'
  );

  chatroomListSocket.onmessage = function(e) {
  const data = JSON.parse(e.data);
  if (data.type === 'chatroom_list_update') {
    // Update the entire chatroom list by replacing the content
    const chatroomListContainer = document.querySelector('.mailbox .message-center');
    if (chatroomListContainer) {
      chatroomListContainer.innerHTML = data.html; // Replace the entire list with updated HTML
    }
  }
};


  chatroomListSocket.onclose = function(e) {
    console.error('Chatroom list socket closed unexpectedly');
  };
</script>


{% endblock %}
{% endblock %}